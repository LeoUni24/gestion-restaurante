<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Productos - Restaurante</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4 bg-light">
  <div class="container">
    <h1 class="mb-4 text-center">Gestión de Productos</h1>

    <form id="form-producto" class="mb-4 card p-3 shadow-sm">
      <input type="hidden" id="id">
      <div class="row g-2">
        <div class="col-md-4"><input type="text" id="nombre" class="form-control" placeholder="Nombre del producto" required></div>
        <div class="col-md-3"><input type="number" step="0.01" id="precio" class="form-control" placeholder="Precio" required></div>
        <div class="col-md-3"><input type="text" id="categoria" class="form-control" placeholder="Categoría" required></div>
        <div class="col-md-2">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="disponible">
            <label class="form-check-label" for="disponible">Disponible</label>
          </div>
        </div>
      </div>
      <div class="mt-3 text-end"><button type="submit" class="btn btn-primary">Guardar</button></div>
    </form>

    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr><th>#</th><th>Nombre</th><th>Precio</th><th>Categoría</th><th>Disponible</th><th>Acciones</th></tr>
      </thead>
      <tbody id="tabla-productos"></tbody>
    </table>
  </div>

 <script>
  const API_URL = "http://localhost:1337/api/productos";
  const form = document.getElementById("form-producto");
  const tabla = document.getElementById("tabla-productos");
  const idInput = document.getElementById("id");

  // =======================
  //   GET - Cargar tabla
  // =======================
  async function cargarTabla() {
    try {
      const res = await fetch(API_URL);
      const data = await res.json();
      console.log("Datos recibidos:", data);

      tabla.innerHTML = "";

      if (!data.data || data.data.length === 0) {
        tabla.innerHTML = `<tr><td colspan="6" class="text-center">No hay productos registrados.</td></tr>`;
        return;
      }

      data.data.forEach((item, i) => {
        const fila = document.createElement("tr");
        fila.setAttribute("data-docid", item.documentId);

        fila.innerHTML = `
          <td>${i + 1}</td>
          <td>${item.nombre}</td>
          <td>${item.precio}</td>
          <td>${item.categoria}</td>
          <td>${item.disponible ? "Sí" : "No"}</td>
          <td>
            <button class="btn btn-warning btn-sm btn-editar">Editar</button>
            <button class="btn btn-danger btn-sm btn-eliminar">Eliminar</button>
          </td>
        `;

        tabla.appendChild(fila);
      });
    } catch (error) {
      console.error("Error al cargar productos:", error);
    }
  }

  // =======================
  //   POST / PUT - Guardar producto
  // =======================
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const producto = {
      nombre: document.getElementById("nombre").value,
      precio: parseFloat(document.getElementById("precio").value),
      categoria: document.getElementById("categoria").value,
      disponible: document.getElementById("disponible").checked
    };

    const docId = idInput.value;
    const url = docId ? `${API_URL}/${docId}` : API_URL;
    const method = docId ? "PUT" : "POST";

    try {
      await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: producto })
      });

      idInput.value = "";
      form.reset();
      cargarTabla();
    } catch (error) {
      console.error("Error al guardar producto:", error);
    }
  });

  // =======================
  //   Editar / Eliminar desde tabla
  // =======================
  tabla.addEventListener("click", async (e) => {
    const fila = e.target.closest("tr");
    if (!fila) return;

    const docId = fila.getAttribute("data-docid");
    const celdas = fila.querySelectorAll("td");

    if (e.target.classList.contains("btn-editar")) {
      document.getElementById("nombre").value = celdas[1].textContent;
      document.getElementById("precio").value = celdas[2].textContent;
      document.getElementById("categoria").value = celdas[3].textContent;
      document.getElementById("disponible").checked = celdas[4].textContent === "Sí";
      idInput.value = docId;
    }

    if (e.target.classList.contains("btn-eliminar")) {
      if (confirm("¿Deseas eliminar este producto?")) {
        try {
          await fetch(`${API_URL}/${docId}`, { method: "DELETE" });
          cargarTabla();
        } catch (error) {
          console.error("Error al eliminar producto:", error);
        }
      }
    }
  });

  // =======================
  //   Inicialización
  // =======================
  cargarTabla();
</script>


</body>
</html>
